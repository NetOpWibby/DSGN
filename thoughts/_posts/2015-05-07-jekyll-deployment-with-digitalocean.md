---
layout:   post-thought
title:    "Jekyll Deployment with DigitalOcean"
date:     2015-05-07
category: post
---

For as long as I've been using Jekyll, I never quite figured out the automated deployment thing. Every time I updated this site (and others), I would then open Transmit and copy the folders/files that were changed. Sometimes, I would forget something and have to upload again. *Terrible*.

Last last night/this morning, I decided to take a crack at it, and also close one of my [outstanding issues](https://github.com/NetOperatorWibby/DSGN/issues/1).

DigitalOcean is where I host my sites and the only way you can access your servers is via SSH or SFTP. For this tutorial, I am using Ubuntu and Apache. [Mina](http://nadarei.co/mina) and [Capistrano](http://capistranorb.com) seem to be the most popular methods for deploying static sites to servers. Mina has proven to be confusing to my feeble mind so I looked for Capistrano tutorials. [I found one](http://liutao.me/2014/03/06/deploy-jekyll-on-digital-ocean-capistrano.html), but it requires an older version of Capistrano for reasons I will detail below. That's not a problem, just a heads-up.

<pre><code>
  # this is the latest version of Capistrano before 3.0, which removes a key feature
  gem install capistrano -v 2.15.5

  # not sure if the `net-ssh` gem is required, but I saw it in the Japanese tutorial I got the bulk of this info from
  # install it if you want, I guess
</code></pre>



Assuming you are already at the base of your local project in Terminal...

<pre><code>
  capify .
</code></pre>



This will automatically add two files to your Jekyll project:

* Capfile
* config/deploy.rb



You probably don't need to edit anything in your `Capfile`, but I like to change single quotes to double quotes in all project files, for consistency. You *do* need to edit the `deploy.rb` file found in your new `config` folder. I have provided a copy of mine below.

<pre><code>
  # replace this with your site's name
  set :application, "SampleApp"

  # your autogenerated Jekyll site resides here, as you know
  set :repository, "_site"

  # !!! Capistrano 3 does away with this useful line
  set :scm, :none

  set :deploy_via, :copy
  set :copy_compression, :gzip
  set :use_sudo, false

  # the name of the user that should be used for deployments on your VPS
  set :user, "admin"

  # the path to deploy to on your VPS
  # this is the most common path on Apache configs, update your own accordingly
  set :deploy_to, "/var/www/html"

  # the ip address of your VPS
  role :web, "123.456.78.900"

  before "deploy:update", "deploy:update_jekyll"

  namespace :deploy do
    [:start, :stop, :restart, :finalize_update].each do |t|
      desc "#{t} task is a no-op with jekyll"
      task t, :roles => :app do ; end
    end

    desc "Run jekyll to update site before uploading"
    task :update_jekyll do
      # clear existing _site
      # build site using jekyll
      # remove Capistrano stuff from build
      %x(rm -rf _site/* && jekyll build && rm _site/Capfile && rm -rf _site/config)
    end
  end
</code></pre>



After you are done modifying the script above to your specifications, run...

<pre><code>
  cap deploy:setup
</code></pre>



You will only need to run this setup command once, unless you change server parameters in the future. Finally, the code to deploy your Jekyll generated site to your server!

<pre><code>
  cap deploy
</code></pre>



Now, what happens when you deploy is your site will be pushed to a symlinked folder on your server called `current`. So, if your regular server path for your site is `/var/www/html`, it will now be `/var/www/html/current`. You will need to update your Apache config to represent that so when visitors go to your site, they will actually see the well, current, version. This [StackOverflow answer](http://stackoverflow.com/a/14966435/1167646) explains it best:

> In Ubuntu the Apache configuration is located at **/etc/apache2**. There should be two folders, **sites-available** and **sites-enabled**. Inside sites-enabled are symlinks to config files in sites-available.<br/><br/>
  You simply have to change the document root in your activated configuration. Thats probably **/etc/apache2/sites-enabled/000-default**<br/><br/>
  Have a look for **DocumentRoot** and change it to **/var/www/new**, then reload your apache.



To reload your cache, SSH into your server via Terminal and run:

<pre><code>
  service apache2 reload
</code></pre>

And that's it! Gone are the days when I left the Terminal to upload things via multiple clicks *like a savage*.



P.S: I noticed that the deploy script didn't exclude the Capistrano files in the Jekyll site generated, so I added these lines to my `_config.yml` file:

<pre><code>
  exclude:
    - Capfile
    - config
</code></pre>